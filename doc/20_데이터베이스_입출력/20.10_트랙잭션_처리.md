# 20.10 트랜잭션 처리

`트랜잭션 (transaction)`은 기능 처리의 최소 단위를 말한다. 하나의 기능은 여러 가지 소작업들로 구성될 수 있다. 최소 단위란 것은 이 소작업들을 분리할 수 없으며, 전체를 하나로 본다는 개념이다. 트랜잭션은 소작업들이 모두 성공하거나 모두 실패 (All or Nothing)해야 한다.

예를 들어 계좌 이체는 DB에서 2개의 계좌 금액을 수정하는 작업이다. 출금 계좌에서 금액을 감소시키고, 입금 계좌에서 금액을 증가시킨다. 따라서 2개의 UPDATE문이 필요한데, 모두 성공하거나 모두 실패해야 한다. 하나만 성공하면 안 된다.

DB는 트랜잭션을 처리하기 위해 `커밋 (commit)`과 `롤백 (rollback)`을 제공한다. 커밋은 내부 작업을 모두 성공 처리하고, 롤백은 실행 전으로 돌아간다는 의미에서 모두 실패 처리한다.

JDBC에서는 INSERT, UPDATE, DELETE문을 실행할 때마다 자동 커밋이 일어난다. 이 기능은 계좌 이체와 같이 2개의 UPDATE문을 실행할 때 문제가 된다. 출금 작업이 성공하면 바로 커밋되기 때문에 입금 작업의 성공 여부와 관계없이 출금 작업이 별도로 처리된다.

따라서 JDBC에서 트랜잭션을 코드로 제어하려면 자동 커밋 기능을 꺼야 한다. 자동 커밋 설정 여부는 `Connection`의 `setAutoCommit()` 메서드로 할 수 있다.

```
conn.setAutoCommit(false);
```

자동 커밋 기능이 꺼지면 커밋과 롤백을 제어할 수 있다.

```
conn.commit(); // 커밋
conn.rollback(); // 롤백
```

트랜잭션을 처리한 이후에는 원래대로 자동 커밋 기능을 켜두는 것이 좋을 수 있다. 특히 커넥션 풀을 사용할 때는 켜야 한다.
자동 커밋 기능이 꺼진 상태에서 반환된 Connection이 있다고 했을 때, 이후 다른 로직 처리에서 해당 Connection을 커밋시켜주는 시점에서 일괄 적용되기 때문이다.
