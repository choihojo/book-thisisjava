# 21.6 가상 스레드

## 21.6.1 가상 스레드 개요

지금까지 자바 개발자들은 서버 애플리케이션에서 사용자 요청을 동시에 처리 (요청별 스레드)하기 위해 스레드 풀링을 사용했다.
여기서 풀링이란 제한된 개수로 스레드를 운용하는 것을 말한다.
스레드 풀에서 초당 200개의 요청을 동시에 처리할 때 10개의 스레드를 사용했다면, 초당 2000개의 요청을 동시에 처리하려면 스레드 풀에는 100개의 스레드가 풀링되어야 한다.

자바 17까지의 스레드는 운영체제가 제공하는 `플랫폼 스레드`를 래핑했기 때문에 스레드와 플랫폼 스레드가 1:1로 매핑되었다.
플랫폼 스레드는 비용 (CPU 또는 메모리 사용량)이 많이 들기 때문에 애플리케이션은 스레드의 수를 제한해서 사용해야 했었다.
따라서 초당 처리되어야 할 요청 수가 늘어난다고 하더라도 스레드 풀의 스레드를 무작정 늘릴 수 없었다.

이러한 단점을 해결하기 위해 자바 21에서는 CPU를 효율적으로 이용하면서 동시 처리량을 확장할 수 있도록 `가상 스레드`를 제공한다.
스레드가 플랫폼 스레드와 1:1로 매핑된다면 가상 스레드는 플랫폼 스레드와 N:1로 매핑된다.
다수의 가상 스레드가 1개의 플랫폼 스레드와 매핑되기 때문에 플랫폼 스레드의 부족 문제를 해결할 수 있게 된다.

가상 스레드는 CPU에서 계산을 수행하는 동안만 플랫폼 스레드를 사용한다.
가상 스레드가 `Blocking I/O 작업 (파일 입출력, 네트워킹)`을 수행할 경우 가상 스레드는 일시 중지되지만, 플랫폼 스레드는 일시 중지되지 않고 다른 가상 스레드의 작업을 처리한다.
그렇기 때문에 CPU 활용도는 최적으로 끌어올리면서 높은 동시 처리량을 달성할 수 있다.

## 21.6.2 가상 스레드 풀 생성

가상 스레드는 메모리가 부족하지 않다면 개수를 무제한으로 사용할 수 있기 때문에 스레드 풀에서 최대 개수를 제한할 필요가 없다.
실제로 가상 스레드 풀을 생성하는 Executors의 메서드는 최대 개수를 입력받지 않는다.

```
ExecutorService platformExecutor = Executors.newFixedThreadPool(최대 개수); // 플랫폼 스레드 풀
ExecutorService virtualExecutor = Executors.newVirtualThreadPerTaskExecutor(); // 가상 스레드 풀
```
